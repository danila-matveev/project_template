# PR Review: Автоматическая проверка с AI-агентами

Запускает цикл проверки Pull Request с помощью Codex и Copilot, исправляет замечания и запускает E2E тесты.

## Когда использовать

- После создания PR
- Для проверки существующего PR перед мержем
- "/pullrequest" или "/pullrequest 27" (с номером PR)

## ВАЖНО: Репозиторий

Этот скилл работает с репозиторием `2030ai/2023ai_tutor`.

## Инструкции

### Шаг 0: Проверить требования agents.md ПЕРЕД началом работы

**ОБЯЗАТЕЛЬНО** перед любыми действиями с PR проверить выполнение требований из `agents.md`:

1. Прочитать `agents.md` и раздел "Чек-лист перед завершением задачи"
2. Убедиться, что выполнены:
   - [ ] Требования задачи выполнены, изменения соответствуют ожидаемому поведению
   - [ ] Релевантные документы обновлены
   - [ ] При необходимости обновлена запись в `agent_docs/development-history.md`
   - [ ] Если принято важное решение — добавлена запись в `agent_docs/adr.md`
   - [ ] Критерии DoD из `agent_docs/dod.md` выполнены или зафиксированы причины
   - [ ] Зафиксированы причины, если тесты не запускались

Если требования НЕ выполнены — сообщить пользователю и предложить исправить до создания/проверки PR.

### Шаг 1: Определить PR

```bash
# Если номер PR не указан — найти текущий PR для ветки
gh pr list --head $(git branch --show-current) --json number,title,url
```

Если PR не найден — предложить создать новый.

### Шаг 2: Запустить проверку Codex

```bash
gh pr comment <PR_NUMBER> --body "@codex проверь"
```

Сообщить пользователю: "Запущена проверка Codex. Ожидание 5 минут..."

### Шаг 3: Ожидание анализа

```bash
sleep 300
```

### Шаг 4: Получить комментарии от AI-агентов

```bash
gh api repos/2030ai/2023ai_tutor/pulls/<PR_NUMBER>/comments \
  --jq '.[] | select(.user.login | test("copilot|codex"; "i")) | "[\(.user.login)] \(.path // "general"):\(.line // "-")\n\(.body)\n---"'
```

Также проверить review comments:
```bash
gh api repos/2030ai/2023ai_tutor/pulls/<PR_NUMBER>/reviews \
  --jq '.[] | select(.user.login | test("copilot|codex"; "i")) | "[\(.user.login)] \(.state)\n\(.body)\n---"'
```

### Шаг 5: Оценить замечания

Показать пользователю найденные замечания в формате:

```markdown
## Замечания от AI-агентов

### P1 (Critical) — требуют исправления
- [ ] [файл:строка] Описание проблемы

### P2 (Important) — рекомендуется исправить
- [ ] [файл:строка] Описание проблемы

### Suggestions — на усмотрение
- [ ] [файл:строка] Описание проблемы
```

Спросить пользователя:
- "Какие замечания исправить?"
- Варианты: "Все P1/P2", "Только P1", "Выбрать вручную", "Пропустить"

### Шаг 6: Исправить замечания

Для каждого выбранного замечания:
1. Прочитать файл с проблемой
2. Понять контекст проблемы
3. Внести исправление
4. Добавить в список выполненных

### Шаг 7: Закоммитить и запушить исправления

```bash
git add -A
git commit -m "fix: address AI review comments

- [список исправленных замечаний]

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
git push
```

### Шаг 8: Повторная проверка требований agents.md ПОСЛЕ исправлений

**ОБЯЗАТЕЛЬНО** после внесения всех исправлений повторно проверить требования из `agents.md`:

1. Перечитать `agents.md` раздел "Чек-лист перед завершением задачи"
2. Убедиться, что после исправлений по-прежнему выполнены:
   - [ ] Изменения соответствуют ожидаемому поведению
   - [ ] Документация актуальна с учётом исправлений
   - [ ] Новые решения задокументированы в `agent_docs/adr.md` (если применимо)
   - [ ] DoD критерии соблюдены
3. Если появились расхождения — исправить и закоммитить

### Шаг 9: Повторить проверку Codex (если были исправления)

Спросить пользователя: "Запустить повторную проверку Codex? (да/нет)"

Если да — вернуться к Шагу 2.

### Шаг 10: Дождаться деплоя

```bash
# Проверить статус GitHub Actions
gh run list --limit 5 --json status,conclusion,name,createdAt

# Ждать завершения деплоя
sleep 300
```

### Шаг 11: E2E тест тьютора (опционально)

Спросить: "Затрагивают ли изменения обработку сообщений? Запустить E2E тест? (да/нет)"

Если да:
```bash
cd tools/telegram-mcp-tester && source .venv/bin/activate
python test_send.py        # Отправить тестовое сообщение
sleep 20                   # Подождать ответа
python test_send.py read   # Проверить ответ тьютора
```

Оценить результат:
- Тьютор ответил адекватно — сообщить об успехе
- Проблемы — предложить задокументировать в `tools/telegram-mcp-tester/simulatedtester/test-YYYY-MM-DD.md`

### Шаг 12: Финальный отчёт

```markdown
## Результат проверки PR #<NUMBER>

**Статус:** ✅ Готов к мержу / ⚠️ Требует внимания

**Проверки:**
- [x] agents.md требования (до PR)
- [x] Codex review
- [x] Исправлены N замечаний
- [x] agents.md требования (после исправлений)
- [x] Деплой завершён
- [x] E2E тест пройден

**Оставшиеся замечания:** (если есть)
- ...

**Следующий шаг:** `gh pr merge <NUMBER> --squash`
```

## Приоритеты замечаний

| Приоритет | Действие |
|-----------|----------|
| P1 (Critical) | Исправить перед мержем |
| P2 (Important) | Рекомендуется исправить |
| Suggestions | На усмотрение |

## Пример использования

```
/pullrequest           # Для текущей ветки
/pullrequest 27        # Для конкретного PR
```
